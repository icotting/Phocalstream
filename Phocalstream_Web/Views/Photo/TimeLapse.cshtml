@model Phocalstream_Web.Models.ViewModels.TimelapseModel

@{
    ViewBag.Title = "";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Scripts
{
    <script type="text/javascript">

    var frameset = @Html.Raw(Json.Encode(Model.Ids));
    var frames;

    var pos = 0;
    var bufferPos = 0;
    var len = 0;

    var running;

    $(document).ready(function () {
        len = frameset.length;
        frames = new Array();
        buffer();
    });


        function buffer() {
            var imageObj = new Image();
            imageObj.onload = function() {
                var complete = parseInt(((bufferPos / len)*100));

                $("#progressLabel").empty();
                $("#progressLabel").append(complete+"%");

                $("#progress").css("width", complete+"%").attr('aria-valuenow', complete);  
                if (bufferPos < len) {
                    buffer();
                } else {
                    var canvas = document.getElementById("stage");
                    canvas.width = 400;
                    canvas.height = 400 * (this.width/this.height);

                    $("#loadDiv").hide();
                    $("#video").show();
                    running = true;
                    nextImage();
                }
            };

            imageObj.src = "/api/photo/low/"+frameset[bufferPos++];
            frames.push(imageObj);
        }

        function nextImage() { 
            var image = frames[pos % len];
            var canvas = document.getElementById("stage");

            var context = canvas.getContext('2d');
            context.drawImage(image, 0, 0);

            if ( running == true) {
                setTimeout(function () { nextImage(); }, 200);
            }

            $("#photoId").empty();
            $("#photoId").append(frameset[pos++ % len]);
        }
  
    function startStop() { 
        if ( running == true ) { 
            $("#controls").removeClass("glyphicon-pause");
            $("#controls").addClass("glyphicon-play");
            running = false;
        } else { 
            $("#controls").removeClass("glyphicon-play");
            $("#controls").addClass("glyphicon-pause");
            running = true; 
            nextImage();
        }
    }
    </script>
}

<div class="container">
    <div class="content">
        <div id="loadDiv">
            <h1 id="bufferlabel">Creating Video</h1>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped active" id="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        <span class="sr-only"></span>
                    </div>
                </div>
                Progress: <span id="progressLabel"></span>
            </div>
        <div id="video" style="display: none;">
            <div class="col-md-8">
                <div id="frames" style="position: relative">
                    <canvas id="stage"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <h3 id="photoId"></h3>
                <button class="btn btn-default" onclick="startStop()">
                    <span id="controls" class="glyphicon glyphicon-pause"></span>
                </button>
            </div>
        </div>
    </div>
</div>